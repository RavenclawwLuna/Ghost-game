<!DOCTYPE html>
<html>
<head>
  <title>Ghost Afterlife Obby</title>
  <style>
    body{
      margin:0;
      background: radial-gradient(circle at top, #14162a, #070711);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      font-family:monospace;
      overflow:hidden;
    }
    canvas{
      border:3px solid rgba(255,255,255,0.85);
      border-radius:16px;
      background: rgba(0,0,0,0.35);
      image-rendering: pixelated;
      box-shadow: 0 0 30px rgba(180,120,255,0.18);
    }
  </style>
</head>
<body>

<canvas id="game" width="640" height="360"></canvas>

<script>
window.onload = function(){
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  /* ---------- GAME STATE ---------- */
  let state = "intro"; // intro, play, blob, heaven, hell, human
  let keys = {};
  let jumpRequest = false;

  /* ---------- PLAYER ---------- */
  const GRAVITY = 0.5;
  let player = { x:80, y:260, w:16, h:18, vy:0, onGround:false };
  let level = 0;
  let respawn = { x:80, y:260 };
  let t = 0;

  /* ---------- BLOB CHOICE ---------- */
  let blobChoice = 0;
  let blobCooldown = 0;

  /* ---------- UTIL ---------- */
  function rectHit(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x &&
           a.y < b.y+b.h && a.y+a.h > b.y;
  }

  function resetToLevel(lv){
    level = lv;
    player.x = levels[level].respawn.x;
    player.y = levels[level].respawn.y;
    player.vy = 0;
    player.onGround = false;
    respawn.x = player.x;
    respawn.y = player.y;
  }

  function hardResetToStart(){
    resetToLevel(0);
  }

  function softRespawn(){
    player.x = respawn.x;
    player.y = respawn.y;
    player.vy = 0;
    player.onGround = false;
  }

  /* ---------- LEVELS ----------
     each: name, theme, blocks, portals, voids, spikes, blobs, decor, respawn
     decor: {type,x,y,...}
  -------------------------------- */
  const levels = [
    // 0 START ROOM
    {
      name:"Start",
      theme:"start",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:140,y:260,w:90,h:18},
        {x:270,y:232,w:90,h:18},
        {x:400,y:204,w:90,h:18},
        {x:0,y:165,w:70,h:18} // secret ledge
      ],
      portals:[
        {x:620,y:260,w:20,h:40,to:1}, // to trap hall
        {x:0,y:260,w:20,h:40,to:2}    // to stairway route
      ],
      voids:[{x:230,y:300,w:70,h:60}],
      spikes:[{x:330,y:292,w:60,h:8}],
      blobs:[{x:520,y:282,w:18,h:18}],
      decor:[
        {type:"lantern",x:80,y:276},
        {type:"stars",x:120,y:60},
        {type:"flowers",x:520,y:292}
      ],
      respawn:{x:80,y:260}
    },

    // 1 TRAP HALL (more dangerous)
    {
      name:"Trap Hall",
      theme:"trap",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:70,y:270,w:60,h:18},
        {x:170,y:245,w:60,h:18},
        {x:260,y:220,w:60,h:18},
        {x:360,y:195,w:60,h:18},
        {x:470,y:230,w:60,h:18}
      ],
      portals:[
        {x:620,y:260,w:20,h:40,to:3}, // to hell maze
        {x:0,y:260,w:20,h:40,to:0}
      ],
      voids:[{x:250,y:300,w:140,h:60}],
      spikes:[
        {x:120,y:292,w:40,h:8},
        {x:420,y:292,w:40,h:8},
        {x:520,y:292,w:60,h:8}
      ],
      blobs:[],
      decor:[
        {type:"candles",x:40,y:290},
        {type:"candles",x:580,y:290},
        {type:"bones",x:300,y:294}
      ],
      respawn:{x:40,y:260}
    },

    // 2 STAIRWAY ROUTE (not heaven yet)
    {
      name:"Stairway",
      theme:"heavenish",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:120,y:272,w:60,h:18},
        {x:200,y:244,w:60,h:18},
        {x:280,y:216,w:60,h:18},
        {x:360,y:188,w:60,h:18},
        {x:440,y:160,w:90,h:18},
        {x:520,y:240,w:70,h:18}
      ],
      portals:[
        {x:570,y:110,w:20,h:40,to:8}, // to Heaven Gate (multi-step)
        {x:620,y:260,w:20,h:40,to:0}
      ],
      voids:[{x:0,y:300,w:60,h:60}],
      spikes:[{x:250,y:292,w:50,h:8}],
      blobs:[],
      decor:[
        {type:"cloud",x:500,y:70},
        {type:"cloud",x:220,y:90},
        {type:"stars",x:140,y:40}
      ],
      respawn:{x:40,y:260}
    },

    // 3 HELL MAZE (not instant hell)
    {
      name:"Hell Maze",
      theme:"hell",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:80,y:262,w:90,h:18},
        {x:210,y:222,w:90,h:18},
        {x:340,y:182,w:90,h:18},
        {x:470,y:222,w:90,h:18},
        {x:560,y:262,w:70,h:18}
      ],
      portals:[
        {x:620,y:260,w:20,h:40,to:9}, // to Hell Core (multi-step)
        {x:0,y:260,w:20,h:40,to:1}
      ],
      voids:[
        {x:260,y:300,w:120,h:60},
        {x:470,y:300,w:80,h:60}
      ],
      spikes:[
        {x:120,y:292,w:40,h:8},
        {x:300,y:292,w:40,h:8},
        {x:520,y:292,w:40,h:8}
      ],
      blobs:[],
      decor:[
        {type:"lava",x:330,y:300},
        {type:"bones",x:90,y:294},
        {type:"skull",x:560,y:292}
      ],
      respawn:{x:40,y:260}
    },

    // 4 BLOB CHAMBER
    {
      name:"Blob Chamber",
      theme:"mystic",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:200,y:250,w:80,h:18},
        {x:360,y:220,w:80,h:18},
        {x:520,y:190,w:80,h:18}
      ],
      portals:[
        {x:0,y:260,w:20,h:40,to:3}
      ],
      voids:[{x:280,y:300,w:80,h:60}],
      spikes:[
        {x:120,y:292,w:60,h:8},
        {x:500,y:292,w:60,h:8}
      ],
      blobs:[{x:310,y:282,w:18,h:18}],
      decor:[
        {type:"crystals",x:100,y:290},
        {type:"crystals",x:520,y:290},
        {type:"stars",x:320,y:40}
      ],
      respawn:{x:40,y:260}
    },

    // 5 BLOB CHOICE 1 ROOM (RIGHT EDGE -> Sky Reach room)
    {
      name:"Soft Light",
      theme:"heavenish",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:160,y:260,w:100,h:18},
        {x:320,y:220,w:100,h:18},
        {x:480,y:180,w:100,h:18},
        {x:580,y:140,w:40,h:18}
      ],
      portals:[
        {x:620,y:260,w:20,h:40,to:4}, // back to blob chamber
        {x:635,y:0,w:10,h:360,to:10}  // RIGHT EDGE secret teleport to Sky Reach
      ],
      voids:[],
      spikes:[{x:250,y:292,w:60,h:8}],
      blobs:[],
      decor:[
        {type:"cloud",x:480,y:70},
        {type:"cloud",x:140,y:90},
        {type:"flowers",x:500,y:292}
      ],
      respawn:{x:40,y:260}
    },

    // 6 BLOB CHOICE 2 ROOM (danger -> hell-ish)
    {
      name:"Ash Pit",
      theme:"hell",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:80,y:250,w:90,h:18},
        {x:220,y:210,w:90,h:18},
        {x:360,y:250,w:90,h:18},
        {x:500,y:210,w:90,h:18}
      ],
      portals:[
        {x:620,y:260,w:20,h:40,to:3},
        {x:0,y:260,w:20,h:40,to:4}
      ],
      voids:[
        {x:140,y:300,w:80,h:60},
        {x:420,y:300,w:80,h:60}
      ],
      spikes:[
        {x:300,y:292,w:60,h:8},
        {x:60,y:292,w:40,h:8}
      ],
      blobs:[],
      decor:[
        {type:"lava",x:220,y:300},
        {type:"bones",x:520,y:294}
      ],
      respawn:{x:40,y:260}
    },

    // 7 BLOB CHOICE 3 ROOM (secret back to start)
    {
      name:"Forgotten Hall",
      theme:"mystic",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:260,y:260,w:120,h:18},
        {x:0,y:220,w:80,h:18},
        {x:560,y:220,w:80,h:18}
      ],
      portals:[
        {x:0,y:260,w:20,h:40,to:0},
        {x:620,y:260,w:20,h:40,to:4}
      ],
      voids:[],
      spikes:[{x:420,y:292,w:80,h:8}],
      blobs:[],
      decor:[
        {type:"lantern",x:60,y:276},
        {type:"lantern",x:560,y:276},
        {type:"crystals",x:320,y:290}
      ],
      respawn:{x:40,y:260}
    },

    // 8 HEAVEN GATE (must complete this before Heaven)
    {
      name:"Heaven Gate",
      theme:"heavenish",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:120,y:260,w:80,h:18},
        {x:240,y:220,w:80,h:18},
        {x:360,y:180,w:80,h:18},
        {x:480,y:140,w:80,h:18}
      ],
      portals:[
        {x:560,y:95,w:20,h:40,to:11}, // to Heaven Final
        {x:0,y:260,w:20,h:40,to:2}
      ],
      voids:[{x:260,y:300,w:100,h:60}],
      spikes:[{x:420,y:292,w:80,h:8}],
      blobs:[],
      decor:[
        {type:"cloud",x:220,y:70},
        {type:"cloud",x:420,y:50},
        {type:"stars",x:140,y:40}
      ],
      respawn:{x:40,y:260}
    },

    // 9 HELL CORE (must survive then reach hell door)
    {
      name:"Hell Core",
      theme:"hell",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:100,y:260,w:80,h:18},
        {x:240,y:230,w:80,h:18},
        {x:380,y:200,w:80,h:18},
        {x:520,y:170,w:80,h:18}
      ],
      portals:[
        {x:600,y:120,w:20,h:60,type:"hell"}, // FINAL hell
        {x:0,y:260,w:20,h:40,to:3}
      ],
      voids:[
        {x:180,y:300,w:120,h:60},
        {x:420,y:300,w:120,h:60}
      ],
      spikes:[
        {x:320,y:292,w:80,h:8},
        {x:60,y:292,w:60,h:8}
      ],
      blobs:[],
      decor:[
        {type:"lava",x:320,y:300},
        {type:"skull",x:580,y:292},
        {type:"bones",x:120,y:294}
      ],
      respawn:{x:40,y:260}
    },

    // 10 SKY REACH ROOM (touch top edge -> Human Obby)
    {
      name:"Sky Reach",
      theme:"mystic",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:80,y:250,w:70,h:18},
        {x:180,y:210,w:70,h:18},
        {x:280,y:170,w:70,h:18},
        {x:380,y:130,w:70,h:18},
        {x:480,y:90,w:70,h:18},
        {x:560,y:50,w:60,h:18}
      ],
      portals:[
        {x:0,y:260,w:20,h:40,to:5}
      ],
      voids:[],
      spikes:[{x:260,y:292,w:60,h:8}],
      blobs:[],
      decor:[
        {type:"stars",x:320,y:40},
        {type:"cloud",x:500,y:30},
        {type:"cloud",x:120,y:60}
      ],
      respawn:{x:40,y:260}
    },

    // 11 HEAVEN FINAL ROOM (real heaven portal)
    {
      name:"Heaven Stairs",
      theme:"heavenish",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:180,y:260,w:80,h:18},
        {x:280,y:230,w:80,h:18},
        {x:380,y:200,w:80,h:18},
        {x:480,y:170,w:80,h:18}
      ],
      portals:[
        {x:540,y:120,w:20,h:40,type:"heaven"},
        {x:0,y:260,w:20,h:40,to:8}
      ],
      voids:[{x:260,y:300,w:80,h:60}],
      spikes:[{x:320,y:292,w:60,h:8}],
      blobs:[],
      decor:[
        {type:"cloud",x:400,y:50},
        {type:"flowers",x:560,y:292},
        {type:"stars",x:140,y:30}
      ],
      respawn:{x:40,y:260}
    },

    // 12 HUMAN OBBY ROOM (only reached by touching top in Sky Reach)
    {
      name:"Human Obby",
      theme:"human",
      blocks:[
        {x:0,y:300,w:640,h:60},
        {x:80,y:260,w:60,h:18},
        {x:170,y:230,w:60,h:18},
        {x:260,y:200,w:60,h:18},
        {x:350,y:170,w:60,h:18},
        {x:440,y:140,w:60,h:18},
        {x:530,y:110,w:60,h:18}
      ],
      portals:[
        {x:590,y:60,w:20,h:50,type:"human"},
        {x:0,y:260,w:20,h:40,to:10}
      ],
      voids:[{x:220,y:300,w:120,h:60}],
      spikes:[{x:360,y:292,w:80,h:8}],
      blobs:[],
      decor:[
        {type:"trees",x:60,y:290},
        {type:"trees",x:560,y:290},
        {type:"butterflies",x:320,y:90}
      ],
      respawn:{x:40,y:260}
    }
  ];

  /* ---------- INPUT ---------- */
  window.addEventListener("keydown", e=>{
    keys[e.code]=true;

    if(state==="intro" && e.code==="Space"){
      state="play";
      resetToLevel(0);
    }

    if(e.code==="Space") jumpRequest=true;

    if(state==="blob"){
      if(e.code==="Digit1") blobChoice = 1;
      if(e.code==="Digit2") blobChoice = 2;
      if(e.code==="Digit3") blobChoice = 3;
      if(e.code==="Escape"){
        state="play";
        blobChoice = 0;
      }
    }
  });
  window.addEventListener("keyup", e=>keys[e.code]=false);

  /* ---------- UPDATE ---------- */
  function update(){
    t++;

    if(state!=="play") return;

    // move
    if(keys["KeyA"]) player.x -= 2.25;
    if(keys["KeyD"]) player.x += 2.25;

    // gravity
    player.vy += GRAVITY;
    player.y += player.vy;
    player.onGround = false;

    // block collisions
    for(const b of levels[level].blocks){
      if(rectHit(player,b)){
        if(player.vy >= 0 && player.y + player.h - player.vy <= b.y + 6){
          player.y = b.y - player.h;
          player.vy = 0;
          player.onGround = true;

          // save respawn
          respawn.x = player.x;
          respawn.y = player.y;
        }
      }
    }

    // jump
    if(jumpRequest && player.onGround){
      player.vy = -9.6;
    }
    jumpRequest = false;

    // touching top edge triggers HUMAN OBBY only if in Sky Reach room
    if(player.y <= 0){
      if(level === 10){
        resetToLevel(12); // human obby
        return;
      }else{
        // otherwise just clamp so you can't cheese
        player.y = 0;
        player.vy = 1;
      }
    }

    // voids soft respawn
    for(const v of levels[level].voids){
      if(rectHit(player,v)){
        softRespawn();
        return;
      }
    }

    // spikes hard reset to start
    for(const s of levels[level].spikes){
      if(rectHit(player,s)){
        hardResetToStart();
        return;
      }
    }

    // blob interaction
    if(blobCooldown>0) blobCooldown--;
    for(const bl of levels[level].blobs){
      if(rectHit(player,bl) && blobCooldown===0){
        state="blob";
        blobChoice=0;
        blobCooldown=40;
        return;
      }
    }

    // portals
    for(const p of levels[level].portals){
      if(rectHit(player,p)){
        if(p.type==="heaven"){ state="heaven"; return; }
        if(p.type==="hell"){ state="hell"; return; }
        if(p.type==="human"){ state="human"; return; }
        if(p.to!==undefined){ resetToLevel(p.to); return; }
      }
    }

    // fall off bottom = soft respawn (harder exploration)
    if(player.y > canvas.height + 80){
      softRespawn();
      return;
    }

    // clamp left edge
    if(player.x < -30) player.x = -30;
    if(player.x > canvas.width + 40) player.x = canvas.width + 40;
  }

  /* ---------- BLOB LOGIC ---------- */
  function updateBlob(){
    if(state!=="blob") return;

    if(blobChoice===1){
      state="play";
      resetToLevel(5); // Soft Light (contains right edge teleport)
      blobChoice=0;
    }else if(blobChoice===2){
      state="play";
      resetToLevel(6); // Ash Pit
      blobChoice=0;
    }else if(blobChoice===3){
      state="play";
      resetToLevel(7); // Forgotten Hall
      blobChoice=0;
    }
  }

  /* ---------- DRAW HELPERS ---------- */
  function drawGlowCircle(x,y,r,alpha){
    ctx.beginPath();
    ctx.fillStyle = "rgba(190,140,255,"+alpha+")";
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
  }

  function drawPlatform(b){
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fillRect(b.x,b.y,b.w,b.h);
    ctx.strokeStyle = "rgba(255,255,255,0.25)";
    ctx.strokeRect(b.x+0.5,b.y+0.5,b.w-1,b.h-1);
  }

  function drawSpikes(s){
    const count = Math.max(2, Math.floor(s.w/10));
    const w = s.w / count;
    for(let i=0;i<count;i++){
      const x = s.x + i*w;
      ctx.beginPath();
      ctx.fillStyle="rgba(255,90,120,0.9)";
      ctx.moveTo(x, s.y+s.h);
      ctx.lineTo(x+w/2, s.y);
      ctx.lineTo(x+w, s.y+s.h);
      ctx.closePath();
      ctx.fill();
    }
  }

  function drawPortal(p){
    if(p.type==="heaven") ctx.fillStyle="rgba(127,255,212,0.9)";
    else if(p.type==="hell") ctx.fillStyle="rgba(255,60,60,0.95)";
    else if(p.type==="human") ctx.fillStyle="rgba(120,200,255,0.95)";
    else ctx.fillStyle="rgba(220,220,220,0.55)";

    ctx.fillRect(p.x,p.y,p.w,p.h);
    ctx.fillStyle="rgba(255,255,255,0.12)";
    ctx.fillRect(p.x-2,p.y-2,p.w+4,p.h+4);
  }

  function drawDecor(d){
    if(d.type==="stars"){
      for(let i=0;i<8;i++){
        const px = d.x + (i*33)%220;
        const py = d.y + (i*17)%60;
        ctx.fillStyle="rgba(255,255,255,0.10)";
        ctx.fillRect(px,py,2,2);
      }
    }
    if(d.type==="cloud"){
      ctx.fillStyle="rgba(255,255,255,0.12)";
      ctx.beginPath();
      ctx.arc(d.x, d.y, 18, 0, Math.PI*2);
      ctx.arc(d.x+20, d.y+5, 14, 0, Math.PI*2);
      ctx.arc(d.x-18, d.y+6, 13, 0, Math.PI*2);
      ctx.fill();
    }
    if(d.type==="flowers"){
      ctx.fillStyle="rgba(255,180,220,0.8)";
      ctx.fillRect(d.x, d.y-4, 3, 4);
      ctx.fillStyle="rgba(120,255,170,0.8)";
      ctx.fillRect(d.x-2, d.y, 7, 3);
    }
    if(d.type==="candles"){
      ctx.fillStyle="rgba(255,255,255,0.7)";
      ctx.fillRect(d.x, d.y-10, 6, 10);
      ctx.fillStyle="rgba(255,200,90,0.9)";
      ctx.fillRect(d.x+2, d.y-14, 2, 4);
    }
    if(d.type==="bones"){
      ctx.fillStyle="rgba(255,255,255,0.35)";
      ctx.fillRect(d.x, d.y-2, 18, 4);
      ctx.fillRect(d.x+6, d.y-6, 6, 12);
    }
    if(d.type==="skull"){
      ctx.fillStyle="rgba(255,255,255,0.45)";
      ctx.fillRect(d.x, d.y-10, 12, 10);
      ctx.fillStyle="rgba(0,0,0,0.4)";
      ctx.fillRect(d.x+3, d.y-7, 2, 2);
      ctx.fillRect(d.x+7, d.y-7, 2, 2);
    }
    if(d.type==="lava"){
      ctx.fillStyle="rgba(255,80,40,0.35)";
      ctx.fillRect(d.x-80, d.y-18, 160, 18);
    }
    if(d.type==="crystals"){
      ctx.fillStyle="rgba(140,200,255,0.55)";
      ctx.beginPath();
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x+8, d.y-18);
      ctx.lineTo(d.x+16, d.y);
      ctx.closePath();
      ctx.fill();
    }
    if(d.type==="lantern"){
      ctx.fillStyle="rgba(255,255,255,0.35)";
      ctx.fillRect(d.x, d.y-18, 8, 14);
      ctx.fillStyle="rgba(255,210,120,0.55)";
      ctx.fillRect(d.x+2, d.y-14, 4, 8);
    }
    if(d.type==="trees"){
      ctx.fillStyle="rgba(80,200,120,0.75)";
      ctx.fillRect(d.x, d.y-20, 14, 20);
      ctx.fillStyle="rgba(60,120,80,0.9)";
      ctx.fillRect(d.x+5, d.y-8, 4, 8);
    }
    if(d.type==="butterflies"){
      ctx.fillStyle="rgba(255,255,255,0.18)";
      for(let i=0;i<6;i++){
        const px = d.x + Math.sin((t+i)*0.05)*40 + i*10;
        const py = d.y + Math.cos((t+i)*0.04)*18;
        ctx.fillRect(px,py,2,2);
      }
    }
  }

  /* ---------- DRAW ---------- */
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,"rgba(40,30,80,0.65)");
    g.addColorStop(1,"rgba(5,5,15,1)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // particles
    for(let i=0;i<26;i++){
      const px = (i*97 + t*0.3) % canvas.width;
      const py = (i*53 + t*0.15) % canvas.height;
      ctx.fillStyle="rgba(255,255,255,0.08)";
      ctx.fillRect(px,py,2,2);
    }

    if(state==="intro"){
      ctx.fillStyle="rgba(0,0,0,0.35)";
      ctx.fillRect(70,60,500,250);

      ctx.fillStyle="#fff";
      ctx.textAlign="center";
      ctx.font="20px monospace";
      ctx.fillText("GHOST AFTERLIFE OBBY", canvas.width/2, 105);

      ctx.font="14px monospace";
      ctx.fillText("You died... and woke up as a ghost.", canvas.width/2, 150);
      ctx.fillText("Find TRUE Heaven. Avoid traps. Explore everything.", canvas.width/2, 175);
      ctx.fillText("Human Realm is extremely rare.", canvas.width/2, 200);
      ctx.fillText("Try to get all 3 endings!", canvas.width/2, 225);

      ctx.fillText("Controls: A/D move   SPACE jump", canvas.width/2, 260);
      ctx.fillText("Press SPACE to begin", canvas.width/2, 285);
      return;
    }

    if(state==="heaven"){
      ctx.fillStyle="white";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.textAlign="center";
      ctx.fillStyle="#111";
      ctx.font="30px monospace";
      ctx.fillText("âœ¨ HEAVEN âœ¨", canvas.width/2, 135);

      ctx.font="16px monospace";
      ctx.fillText("You reached the true afterlife.", canvas.width/2, 175);
      ctx.fillText("Try to get all 3 endings!", canvas.width/2, 205);
      ctx.fillText("Endings: Heaven / Hell / Human Realm", canvas.width/2, 230);
      ctx.fillText("Refresh to play again.", canvas.width/2, 270);
      return;
    }

    if(state==="hell"){
      ctx.fillStyle="#ff2f2f";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.textAlign="center";
      ctx.fillStyle="#000";
      ctx.font="30px monospace";
      ctx.fillText("ðŸ”¥ HELL ðŸ”¥", canvas.width/2, 135);

      ctx.font="16px monospace";
      ctx.fillText("The void consumed your soul.", canvas.width/2, 175);
      ctx.fillText("Try to get all 3 endings!", canvas.width/2, 205);
      ctx.fillText("Endings: Heaven / Hell / Human Realm", canvas.width/2, 230);
      ctx.fillText("Refresh to try again.", canvas.width/2, 270);
      return;
    }

    if(state==="human"){
      ctx.fillStyle="#2b6cff";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.textAlign="center";
      ctx.fillStyle="#fff";
      ctx.font="28px monospace";
      ctx.fillText("ðŸŒŒ HUMAN REALM ðŸŒŒ", canvas.width/2, 135);

      ctx.font="16px monospace";
      ctx.fillText("You escaped fate itself.", canvas.width/2, 175);
      ctx.fillText("This ending is rare.", canvas.width/2, 200);
      ctx.fillText("Try to get all 3 endings!", canvas.width/2, 230);
      ctx.fillText("Refresh to play again.", canvas.width/2, 270);
      return;
    }

    if(state==="blob"){
      ctx.fillStyle="rgba(0,0,0,0.55)";
      ctx.fillRect(70,70,500,220);

      ctx.textAlign="center";
      ctx.fillStyle="#fff";
      ctx.font="18px monospace";
      ctx.fillText("A strange blob speaks...", canvas.width/2, 115);

      ctx.font="14px monospace";
      ctx.fillText('"Pick a door. Every door changes your fate."', canvas.width/2, 155);

      ctx.fillText("1) Ask for light", canvas.width/2, 200);
      ctx.fillText("2) Ask for power", canvas.width/2, 225);
      ctx.fillText("3) Ask for truth", canvas.width/2, 250);

      ctx.fillText("(Press 1/2/3. ESC to leave.)", canvas.width/2, 285);
      return;
    }

    // play draw
    const lv = levels[level];

    // decor
    for(const d of lv.decor) drawDecor(d);

    // blocks
    for(const b of lv.blocks) drawPlatform(b);

    // voids
    ctx.fillStyle="rgba(0,0,0,0.88)";
    for(const v of lv.voids){
      ctx.fillRect(v.x,v.y,v.w,v.h);
    }

    // spikes
    for(const s of lv.spikes) drawSpikes(s);

    // portals
    for(const p of lv.portals) drawPortal(p);

    // blob
    for(const bl of lv.blobs){
      drawGlowCircle(bl.x+bl.w/2, bl.y+bl.h/2, 12, 0.18);
      ctx.fillStyle="rgba(141,255,106,0.92)";
      ctx.fillRect(bl.x,bl.y,bl.w,bl.h);
      ctx.fillStyle="rgba(255,255,255,0.35)";
      ctx.fillRect(bl.x+4, bl.y+5, 3, 3);
    }

    // ghost
    const bob = Math.sin(t*0.08)*2;
    const gx = player.x;
    const gy = player.y + bob;

    drawGlowCircle(gx+player.w/2, gy+player.h/2, 18, 0.14);
    drawGlowCircle(gx+player.w/2, gy+player.h/2, 10, 0.20);

    ctx.fillStyle="rgba(255,255,255,0.88)";
    ctx.beginPath();
    ctx.roundRect(gx, gy, player.w, player.h, 6);
    ctx.fill();

    ctx.fillStyle="rgba(40,20,70,0.8)";
    ctx.fillRect(gx+4, gy+6, 3, 3);
    ctx.fillRect(gx+9, gy+6, 3, 3);

    // UI
    ctx.fillStyle="rgba(0,0,0,0.35)";
    ctx.fillRect(8,8,270,52);
    ctx.fillStyle="#fff";
    ctx.font="12px monospace";
    ctx.textAlign="left";
    ctx.fillText("Room: "+lv.name, 16, 24);
    ctx.fillText("A/D move  SPACE jump", 16, 40);
    ctx.fillText("Explore: Blob rooms hide secrets", 16, 56);
  }

  /* ---------- LOOP ---------- */
  function loop(){
    update();
    updateBlob();
    draw();
    requestAnimationFrame(loop);
  }
  loop();
};
</script>

</body>
</html>
